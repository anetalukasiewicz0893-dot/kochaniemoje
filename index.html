<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A ♥ S</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@1,300;1,400;1,500;1,600&family=Outfit:wght@200;300;400;500;600;800&family=Allura&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #fffafa; 
            --ink: #5c5252; 
            --ink-muted: #a89a9a;
            --accent-a: rgba(220, 180, 230, 0.55); 
            --accent-s: rgba(180, 210, 230, 0.55); 
            --rose: #e5989b;
            --card-bg: rgba(255, 255, 255, 0.4);
            --card-border: rgba(255, 255, 255, 0.7);
            --font-main: 'Outfit', sans-serif;
            --font-display: 'Cormorant Garamond', serif;
        }

        html, body {
            width: 100%; height: 100%; overflow: hidden;
            font-family: var(--font-main);
            background: var(--bg);
            color: var(--ink);
            -webkit-tap-highlight-color: transparent;
        }

        /* ═ BACKGROUND ═ */
        #pCanvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
        .grain { position: fixed; inset: 0; z-index: 1; pointer-events: none; opacity: 0.03; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }

        .page {
            position: fixed; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
            z-index: 10; visibility: hidden; opacity: 0; transition: opacity 0.6s ease;
        }
        .page.on { visibility: visible; opacity: 1; }

        .content-wrap { width: 100%; max-width: 450px; display: flex; flex-direction: column; align-items: center; text-align: center; }

        /* ═ HEADERS & INSTRUCTIONS ═ */
        .page-header {
            position: absolute; top: 8%; left: 0; right: 0; 
            display: flex; flex-direction: column; align-items: center; 
            z-index: 20; padding: 0 20px;
        }
        .page-title {
            font-family: var(--font-display); font-size: 34px; font-weight: 500; 
            color: var(--rose); margin-bottom: 8px; text-align: center;
        }
        .instruction-text {
            font-family: var(--font-display); font-size: 16px; font-style: italic; color: var(--ink-muted);
            text-align: center; max-width: 320px; line-height: 1.4;
        }

        /* ═ BUTTONS ═ */
        .btn-pill {
            font-family: var(--font-main); font-weight: 500; text-transform: uppercase; letter-spacing: 1.5px; font-size: 10px;
            border: 1px solid var(--card-border); border-radius: 999px; cursor: pointer; transition: 0.3s;
            background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); color: var(--ink); padding: 12px 24px;
        }
        .btn-pill:hover { background: #fff; border-color: var(--rose); }

        .nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; display: flex; justify-content: center; padding: 15px 16px calc(15px + env(safe-area-inset-bottom, 0px)); }
        .nav-pill { display: flex; gap: 4px; padding: 6px; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(25px); border: 1px solid var(--card-border); border-radius: 999px; box-shadow: 0 4px 30px rgba(0,0,0,0.03); }
        .nb { position: relative; width: 50px; height: 44px; border: none; border-radius: 999px; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; color: var(--ink-muted); }
        .nb svg { width: 22px; height: 22px; stroke-width: 1.2; }
        .nb.on { background: #fff; color: var(--rose); box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
        .nb-tip { position: absolute; bottom: -12px; font-size: 6px; font-weight: 800; text-transform: uppercase; opacity: 0; letter-spacing: 1px; }
        .nb.on .nb-tip { opacity: 1; }

        .top-heart-btn { position: fixed; top: 20px; right: 20px; z-index: 110; width: 42px; height: 42px; border-radius: 50%; border: 1px solid var(--card-border); background: rgba(255,255,255,0.4); backdrop-filter: blur(10px); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--rose); font-size: 20px; transition: 0.3s; }

        /* ═ TITLES & COUNTERS ═ */
        .hc { display: flex; gap: 40px; margin-bottom: 20px; }
        .cn { font-family: var(--font-display); font-size: 64px; font-weight: 300; line-height: 1; letter-spacing: -3px; color: var(--rose); opacity: 0.7; }
        .cl { font-size: 8px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--ink-muted); margin-top: 8px; }
        .ht { font-family: 'Allura', cursive; font-size: clamp(90px, 22vw, 150px); line-height: 0.9; margin-bottom: 10px; color: var(--ink); }
        .hs { font-size: 9px; font-weight: 800; letter-spacing: 5px; text-transform: uppercase; color: var(--ink-muted); }

        /* ═ QUESTION CARD ═ */
        .qc { 
            background: var(--card-bg); 
            backdrop-filter: blur(20px); 
            border: 1px solid var(--card-border); 
            border-radius: 25px; 
            padding: 40px 30px; 
            min-height: 180px; 
            height: fit-content; 
            width: 100%; 
            max-width: 380px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.02); 
            margin-top: 40px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            transition: all 0.4s ease; 
        }
        .qq { font-family: var(--font-display); font-size: 24px; color: var(--ink); line-height: 1.5; }
        .qfill { height: 100%; background: linear-gradient(90deg, var(--accent-a), var(--accent-s)); transition: width 0.7s ease; }

        .q-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; width: 100%; }
        .btn-q-nav { background: rgba(255,255,255,0.6); border: 1px solid var(--card-border); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; color: var(--ink); font-size: 16px; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .btn-q-nav:hover { background: #fff; }
        .btn-q-nav:disabled { opacity: 0; pointer-events: none; }

        /* ═ BUBBLES & ITEMS ═ */
        .tf { position: absolute; top: 160px; bottom: 140px; left: 0; right: 0; overflow: hidden; pointer-events: none; }
        .bb { position: absolute; max-width: 180px; padding: 14px 20px; border-radius: 20px; font-size: 13px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); animation: bf 20s infinite alternate ease-in-out; pointer-events: auto; }
        .bb.bA { background: var(--accent-a); color: #4d2d4f; border: 1px solid rgba(255, 255, 255, 0.4); }
        .bb.bS { background: var(--accent-s); color: #2d414f; border: 1px solid rgba(255, 255, 255, 0.4); }
        .bt { display: block; font-size: 8px; font-weight: 800; opacity: 0.5; margin-bottom: 5px; text-transform: uppercase; }

        @keyframes bf { 0%{transform:translate(0,0) rotate(0deg)} 100%{transform:translate(10px,-15px) rotate(1deg)} }

        .whisper-item { background: var(--card-bg); backdrop-filter: blur(15px); border: 1px solid var(--card-border); padding: 25px; border-radius: 25px; width: 100%; max-width: 340px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .whisper-item.wA { background: var(--accent-a); color: #4d2d4f; }
        .whisper-item.wS { background: var(--accent-s); color: #2d414f; }
        .whisper-q { font-family: var(--font-display); font-size: 21px; font-style: italic; margin-bottom: 20px; }

        /* ═ INPUT ═ */
        .input-bar { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; width: calc(100% - 40px); max-width: 450px; z-index: 100; }
        .author-sel { display: flex; gap: 2px; padding: 4px; background: rgba(255, 255, 255, 0.6); border: 1px solid var(--card-border); border-radius: 999px; }
        .auth-btn { width: 38px; height: 38px; border-radius: 50%; border: none; font-family: var(--font-main); font-weight: 800; font-size: 14px; cursor: pointer; transition: 0.3s; background: transparent; color: var(--ink-muted); }
        .auth-btn.active-A { background: var(--accent-a); color: #4d2d4f; }
        .auth-btn.active-S { background: var(--accent-s); color: #2d414f; }
        .field-wrap { flex: 1; display: flex; align-items: center; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); border: 1px solid var(--card-border); border-radius: 999px; padding: 4px 4px 4px 20px; }
        .field-wrap input { flex: 1; border: none; background: transparent; outline: none; font-size: 14px; color: var(--ink); font-family: var(--font-main); }
        .send-btn { width: 38px; height: 38px; border-radius: 50%; border: none; background: var(--ink); color: #fff; cursor: pointer; font-size: 18px; }

        .mbg { position: fixed; inset: 0; z-index: 200; background: rgba(0, 0, 0, 0.08); backdrop-filter: blur(20px); display: none; align-items: center; justify-content: center; padding: 24px; opacity: 0; transition: 0.3s; }
        .mbg.op { opacity: 1; display: flex; }
        .mbox { width: 100%; max-width: 310px; background: #fff; border-radius: 25px; padding: 40px 30px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.06); }

        #pdfT { position: absolute; left: -9999px; top: 0; width: 800px; padding: 80px; background: #fff; text-align: center; }
        #pdfT h1 { font-family: 'Allura', cursive; font-size: 100px; color: #3d1a1a; }

        ::-webkit-scrollbar { display: none; }

        /* ═ LOGIN OVERLAY ═ */
        #loginScreen {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="content-wrap" style="padding: 20px; z-index: 10000;">
        <h1 class="ht" style="font-size: 80px; margin-bottom: 20px;">A ♥ S</h1>
        <p class="instruction-text" style="position: static; margin-bottom: 30px;">♥ Podaj datę naszego pierwszego spotkania</p>
        
        <div class="field-wrap" style="width: 100%; max-width: 250px; margin-bottom: 20px; padding: 4px;">
            <input type="text" id="pwdInput" placeholder="DD.MM.RRRR" style="text-align: center; width: 100%; padding: 12px 0;">
        </div>
        
        <button class="btn-pill" onclick="checkPwd()" style="color: var(--rose); border-color: var(--rose); padding: 14px 40px; font-size: 12px;">♥ Wejdź</button>
        <p id="pwdErr" style="color: #e5989b; font-size: 12px; margin-top: 20px; opacity: 0; transition: 0.3s;">Niepoprawna data, spróbuj jeszcze raz...</p>
    </div>
    
    <canvas id="loginCanvas" style="position: absolute; inset: 0; z-index: 0; pointer-events: none; opacity: 0.5;"></canvas>
</div>

<canvas id="pCanvas"></canvas>
<div class="grain"></div>

<button class="top-heart-btn" onclick="oM()">♡</button>

<section class="page on" id="pg-home">
    <div class="content-wrap">
        <div class="hc">
            <div class="cb"><div class="cn" id="cT">—</div><div class="cl">Dni razem</div></div>
            <div style="width:1px; background:var(--ink-muted); height:50px; opacity:0.2; align-self:center;"></div>
            <div class="cb"><div class="cn" id="cA">—</div><div class="cl">Dni osobno</div></div>
        </div>
        <h1 class="ht">A ♥ S</h1>
        <p class="hs">♥ od pierwszego dnia...</p>
    </div>
</section>

<section class="page" id="pg-questions">
    <div class="page-header">
        <h2 class="page-title">♥ Pytania ♥</h2>
        <p class="instruction-text">Te 36 pytań ma nas podobno do siebie zbliżyć but idk let's see </p>
    </div>

    <div class="content-wrap" style="margin-top: 60px;">
        <div style="width:100%; text-align:center;">
            <div style="height:2px; background:rgba(0,0,0,0.04); border-radius:2px; overflow:hidden; margin-bottom:12px;">
                <div class="qfill" id="qF" style="width:0%"></div>
            </div>
            <div style="font-size:9px; font-weight:800; letter-spacing:3px; color:var(--ink-muted);" id="qL">0 / 36</div>
        </div>
        
        <div class="qc" id="qCard">
            <div id="qN" style="font-family:var(--font-display); font-size:60px; color:var(--ink-muted); opacity:0.15; margin-bottom:10px;"></div>
            <p class="qq" id="qQ" style="color: var(--ink);"></p>

            <div class="q-controls">
                <button class="btn-q-nav" id="btnPrev" onclick="prevQ()">←</button>
                <button class="btn-pill" id="btnDone" onclick="completeQ()" style="border-color:var(--rose); color:var(--rose);">Następne</button>
                <button class="btn-q-nav" id="btnNext" onclick="nextQ()">→</button>
            </div>
        </div>
    </div>
</section>

<section class="page" id="pg-thoughts">
    <div class="page-header">
        <h2 class="page-title">♥ Myśli ♥</h2>
        <p class="instruction-text">Tutaj możemy napisać sobie miłe słówka w ciągu dnia a potem eksportować do PDF</p>
    </div>

    <div class="tf" id="tF"></div>
    <div class="input-bar">
        <div class="author-sel">
            <button id="bA-t" onclick="pA('A')" class="auth-btn active-A">A</button>
            <button id="bS-t" onclick="pA('S')" class="auth-btn">S</button>
        </div>
        <div class="field-wrap">
            <input type="text" id="tI" placeholder="♥ Napisz mi cos miłego" maxlength="140">
            <button onclick="sT()" class="send-btn">↑</button>
        </div>
    </div>
</section>

<section class="page" id="pg-whispers">
    <div class="page-header">
        <h2 class="page-title">Szepty</h2>
        <p class="instruction-text">Po napisaniu sekretu można go usunąć. Może też odważysz się i poczekasz aż druga osoba go zobaczy i usunie ;)?</p>
    </div>

    <div id="wList" style="width:100%; display:flex; flex-direction:column; align-items:center; overflow-y:auto; max-height: 45vh; margin-top: 140px;"></div>
    
    <div class="input-bar">
        <div class="author-sel">
            <button id="bA-w" onclick="pA('A')" class="auth-btn active-A">A</button>
            <button id="bS-w" onclick="pA('S')" class="auth-btn">S</button>
        </div>
        <div class="field-wrap">
            <input type="text" id="wI" placeholder="Śmiało... nikt nie dowie" maxlength="140">
            <button onclick="sW()" class="send-btn">↑</button>
        </div>
    </div>
</section>

<nav class="nav">
    <div class="nav-pill">
        <button class="nb on" data-p="home" onclick="go('home')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg><span class="nb-tip">A ♥ S</span></button>
        <button class="nb" data-p="questions" onclick="go('questions')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M12 16h.01M12 12.5V11a2 2 0 1 1 2-2"/></svg><span class="nb-tip">Pytania</span></button>
        <button class="nb" data-p="thoughts" onclick="go('thoughts')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span class="nb-tip">♥ Myśli</span></button>
        <button class="nb" data-p="whispers" onclick="go('whispers')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3c-4.97 0-9 3.134-9 7 0 1.622.716 3.106 1.914 4.256L4 18l3.75-1.5c.394.093.805.15 1.25.15 4.97 0 9-3.134 9-7s-4.03-7-9-7z"/><circle cx="9" cy="10.5" r="1"/><circle cx="12" cy="10.5" r="1"/><circle cx="15" cy="10.5" r="1"/></svg><span class="nb-tip">Szepty</span></button>
    </div>
</nav>

<div class="mbg" id="mdl" onclick="if(event.target===this)cM()">
    <div class="mbox">
        <div style="font-size:10px; font-weight:800; letter-spacing:3px; text-transform:uppercase; color:var(--rose); margin-bottom:30px;">USTAWIENIA</div>
        <button class="btn-pill" style="width: 100%; margin-bottom: 12px;" onclick="mPDF()">⤓ &nbsp;♥ Zapisz Myśli (PDF)</button>
        <button class="btn-pill" style="width: 100%; margin-bottom: 12px;" onclick="lockApp()">Zablokuj aplikację</button>
        <div style="height:1px; background:rgba(0,0,0,0.05); margin:15px 0;"></div>
        <button class="btn-pill" style="width: 100%; color: var(--rose); border-color: var(--rose); margin-bottom: 12px;" onclick="nuke()">Resetuj wszystko</button>
        <button class="btn-pill" style="border:none; font-size:10px; color:var(--ink-muted);" onclick="cM()">Zamknij</button>
    </div>
</div>

<div id="pdfT"><h1>A ♥ S</h1><p style="text-transform:uppercase; letter-spacing:6px; font-size:12px; color:#9e958b; margin-top:10px;">Nasze Myśli</p><div class="pg" id="pG"></div></div>

<script>
/* ═ ZABEZPIECZENIE HASŁEM ═ */
// Zmieniony klucz, żeby od razu wymusić ekran logowania na nowej wersji
if(localStorage.getItem('as_auth_v4') === 'true') {
    document.getElementById('loginScreen').style.display = 'none';
}

function checkPwd() {
    var val = document.getElementById('pwdInput').value.trim();
    if(val === '23.12.2024') {
        localStorage.setItem('as_auth_v4', 'true');
        var ls = document.getElementById('loginScreen');
        ls.style.opacity = '0';
        setTimeout(() => { ls.style.display = 'none'; }, 500);
    } else {
        document.getElementById('pwdErr').style.opacity = '1';
        setTimeout(() => { document.getElementById('pwdErr').style.opacity = '0'; }, 3000);
    }
}

function lockApp() {
    localStorage.removeItem('as_auth_v4');
    location.reload();
}

/* ═ ENGINE I DANE ═ */
var START='2024-12-23', APART='2026-01-29';
var QS=["Gdybyś mógł zaprosić dowolną osobę na obiad, kogo byś wybrał?", "Czy chciałbyś być sławny? W jaki sposób?", "Czy przed wykonaniem telefonu układasz sobie w głowie, co powiesz?", "Co stanowiłoby dla Ciebie \u201Edzień idealny\u201D?", "Kiedy ostatnio śpiewałeś sam dla siebie? A dla kogoś innego?", "Gdybyś mógł zachować umysł LUB ciało 30-latka do końca życia, co wybierasz?", "Czy masz przeczucie, w jaki sposób umrzesz?", "Wymień trzy rzeczy, które wydają się nam wspólne.", "Za co w swoim życiu czujesz największą wdzięczność?", "Gdybyś mógł zmienić cokolwiek w swoim wychowaniu, co by to było?", "Opowiedz historię swojego życia w 4 minuty.", "Gdybyś mógł obudzić się z nową umiejętnością, co by to było?", "Gdyby kryształowa kula mogła wyjawić Ci jedną prawdę, o co byś zapytał?", "Czy jest coś, o czym marzysz od dawna? Dlaczego tego nie zrobiłeś?", "Co jest Twoim największym życiowym osiągnięciem?", "Co najbardziej cenisz w przyjaźni?", "Jakie jest Twoje najcenniejsze wspomnienie?", "Jakie jest Twoje najgorsze wspomnienie?", "Gdybyś wiedział, że za rok umrzesz, co byś zmienił?", "Co dla Ciebie oznacza przyjaźń?", "Jaką rolę odgrywają w Twoim życiu miłość i czułość?", "Wymień 5 moich cech, które uważasz za pozytywne.", "Jak bliskie są Twoje relacje z rodziną?", "Co sądzisz o swojej relacji z matką?", "Ułóż trzy zdania zaczynające się od \u201EMy...\u201D", "Dokończ: \u201EChciałbym mieć kogoś, z kim mógłbym dzielić...\u201D", "Gdybyś miał zostać moim przyjacielem, co musiałabym o Tobie wiedzieć?", "Powiedz mi szczerze, co we mnie lubisz.", "Opisz najbardziej zawstydzającą chwilę w swoim życiu.", "Kiedy ostatnio płakałeś przy kimś? A sam?", "Powiedz mi coś, co już teraz we mnie lubisz.", "Co jest zbyt poważne, aby z tego żartować?", "Czego żałowałbyś, że komuś nie powiedziałeś, gdybyś dziś umarł?", "Twój dom płonie. Ratujesz jedną rzecz \u2014 co to jest?", "Śmierć którego członka rodziny byłaby dla Ciebie najtrudniejsza?", "Podziel się problemem i poproś mnie o radę."];

var cp='home', au='A';

/* ═ VALENTINE ENGINE ═ */
function runHearts(canvasId) {
    var c=document.getElementById(canvasId); if(!c)return;
    var x=c.getContext('2d'), d=[];
    function rs(){c.width=window.innerWidth;c.height=window.innerHeight;}
    rs(); window.addEventListener('resize',rs);
    function drawH(ctx, x, y, size, color) {
        ctx.save(); ctx.beginPath(); ctx.translate(x, y);
        ctx.moveTo(0, 0);
        ctx.bezierCurveTo(-size/2, -size/2, -size, size/3, 0, size);
        ctx.bezierCurveTo(size, size/3, size/2, -size/2, 0, 0);
        ctx.fillStyle = color; ctx.fill(); ctx.restore();
    }
    for(var i=0;i<65;i++) d.push({x:Math.random()*c.width,y:Math.random()*c.height,s:Math.random()*7+5,vx:(Math.random()-0.5)*0.22,vy:(Math.random()-0.5)*0.22,a:Math.random()*0.25+0.2,cl:Math.random()>0.5?'rgba(220, 180, 230,':'rgba(180, 210, 230,'});
    (function lp(){x.clearRect(0,0,c.width,c.height);for(var i=0;i<d.length;i++){var p=d[i];p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=c.width;if(p.x>c.width)p.x=0;if(p.y<0)p.y=c.height;if(p.y>c.height)p.y=0;drawH(x, p.x, p.y, p.s, p.cl+p.a+')');}requestAnimationFrame(lp);})();
}
runHearts('pCanvas');
runHearts('loginCanvas'); 

/* ═ QUESTION LOGIC ═ */
let maxQ = parseInt(localStorage.getItem('s_maxQ') || '0'); 
let curQ = maxQ; 

function rQ() {
    if (curQ > 35) curQ = 35;
    if (maxQ > 36) maxQ = 36;

    document.getElementById('qF').style.width = ((maxQ / 36) * 100) + '%';
    document.getElementById('qL').textContent = maxQ + ' / 36';

    let qn = document.getElementById('qN');
    let qq = document.getElementById('qQ');
    let bp = document.getElementById('btnPrev');
    let bn = document.getElementById('btnNext');
    let bd = document.getElementById('btnDone');

    if (maxQ >= 36 && curQ >= 35) {
        qn.textContent = '∞';
        qq.textContent = '♥ Przeszliście wszystkie 36 pytań. ♥ Now kiss.';
        bp.style.opacity = '1'; bp.disabled = false;
        bn.style.opacity = '0'; bn.disabled = true;
        bd.style.display = 'none';
        return;
    }

    qn.textContent = curQ + 1;
    qq.textContent = QS[curQ];

    if (curQ > 0) { bp.style.opacity = '1'; bp.disabled = false; } 
    else { bp.style.opacity = '0'; bp.disabled = true; }

    if (curQ < maxQ) {
        bn.style.opacity = '1'; bn.disabled = false;
        bd.style.display = 'none'; 
    } else {
        bn.style.opacity = '0'; bn.disabled = true;
        bd.style.display = 'block'; 
    }
}

function prevQ() { if(curQ > 0) { curQ--; rQ(); } }
function nextQ() { if(curQ < maxQ) { curQ++; rQ(); } }
function completeQ() {
    if(curQ === maxQ) {
        maxQ++;
        localStorage.setItem('s_maxQ', maxQ);
        curQ = maxQ; 
        if(curQ > 35) curQ = 35; 
        rQ();
    }
}

/* ═ API SYNC LOGIC ═ */
let renderedThoughts = new Set(); 

async function sync() {
    try {
        const res = await fetch('/api/data');
        const data = await res.json();
        
        if (data.thoughts) {
            data.thoughts.forEach(t => {
                const thoughtId = t._id || (t.t + t.a);
                if (!renderedThoughts.has(thoughtId)) {
                    mkB(t.t, t.a);
                    renderedThoughts.add(thoughtId);
                }
            });
        }

        const l = document.getElementById('wList');
        l.innerHTML = '';
        if (data.whispers) {
            data.whispers.forEach(it => {
                var el = document.createElement('div'); el.className = 'whisper-item w' + it.a;
                el.innerHTML = `<div class="whisper-q">${it.t}</div>
                                <button class="btn-pill" style="padding:8px 18px; font-size:9px;" onclick="burnW('${it._id}')">♥ Odpowiedziane. (usuń)</button>`;
                l.appendChild(el);
            });
        }
    } catch (e) { console.error("Sync Error", e); }
}

async function sT() {
    var inp = document.getElementById('tI'), txt = inp.value.trim(); if(!txt) return;
    await fetch('/api/thoughts', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({t: txt, a: au, d: new Date().toLocaleDateString('pl-PL')}) });
    inp.value = ''; sync();
}

async function sW() {
    var i = document.getElementById('wI'), txt = i.value.trim(); if(!txt) return;
    await fetch('/api/whispers', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({t: txt, a: au}) });
    i.value = ''; sync();
}

async function burnW(id) { await fetch('/api/whispers/' + id, { method: 'DELETE' }); sync(); }

/* ═ CORE UI ═ */
function go(n){
    if(n===cp)return; cp=n;
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
    document.getElementById('pg-'+n).classList.add('on');
    document.querySelectorAll('.nb').forEach(b=>b.classList.toggle('on',b.getAttribute('data-p')===n));
}
function uC(){
    var n=Date.now();
    document.getElementById('cT').textContent=Math.floor((n-new Date(START).getTime())/864e5);
    document.getElementById('cA').textContent=Math.max(0,Math.floor((n-new Date(APART).getTime())/864e5));
}

function pA(a){
    au=a;
    ['t','w'].forEach(p => {
        document.getElementById('bA-'+p).className='auth-btn'+(a==='A'?' active-A':'');
        document.getElementById('bS-'+p).className='auth-btn'+(a==='S'?' active-S':'');
    });
}
function mkB(txt,who){
    var f=document.getElementById('tF'); var tp=Math.random()*50+20, lf=Math.random()*55+15;
    var el=document.createElement('div'); el.className='bb b'+who; el.style.top=tp+'%'; el.style.left=lf+'%'; el.innerHTML='<span class="bt">'+who+'</span>'+txt;
    f.appendChild(el);
}
function oM(){document.getElementById('mdl').classList.add('op');}
function cM(){document.getElementById('mdl').classList.remove('op');}
function nuke(){ if(confirm('Zresetować wszystko?')){ fetch('/api/nuke', {method:'DELETE'}).then(()=>location.reload()); } }

async function mPDF(){
    try {
        const res = await fetch('/api/data');
        const data = await res.json();
        const a = data.thoughts || [];
        if(!a.length){alert('Brak myśli do eksportu'); return;}
        
        var g=document.getElementById('pG'); g.innerHTML=''; 
        a.forEach(it=>{ 
            var d=document.createElement('div'); d.className='pc p'+it.a; 
            d.innerHTML='<div style="font-size:9px; opacity:0.5; margin-bottom:5px;">'+(it.d||'')+' · '+it.a+'</div>'+it.t; 
            g.appendChild(d); 
        });
        
        cM(); 
        setTimeout(()=>{ 
            html2canvas(document.getElementById('pdfT'),{scale:2}).then(cv=>{ 
                var pdf=new jspdf.jsPDF('p','mm','a4'), w=pdf.internal.pageSize.getWidth(); 
                pdf.addImage(cv.toDataURL('image/png'),'PNG',0,0,w,(cv.height*w)/cv.width); 
                pdf.save('AS_Archive.pdf'); 
            }); 
        },500);
    } catch(e) { alert("Błąd pobierania danych do PDF"); }
}

uC(); setInterval(uC,6e4); rQ(); 
setInterval(sync, 5000); 
sync(); 

</script>
</body>
</html>
